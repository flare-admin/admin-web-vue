# åŠ¨æ€è·¯ç”±ç³»ç»Ÿä½¿ç”¨è¯´æ˜

## æ¦‚è¿°

æœ¬é¡¹ç›®å®ç°äº†åŸºäºæœåŠ¡ç«¯çš„åŠ¨æ€è·¯ç”±ç³»ç»Ÿï¼Œå¯ä»¥é€šè¿‡ `getUserMenus` æ–¹æ³•è·å–ç”¨æˆ·èœå•ä¿¡æ¯ï¼ŒåŠ¨æ€æ„å»ºè·¯ç”±å’Œèœå•ã€‚

## æ ¸å¿ƒç‰¹æ€§

- ğŸš€ **åŠ¨æ€è·¯ç”±ç”Ÿæˆ**: æ ¹æ®æœåŠ¡ç«¯è¿”å›çš„èœå•é…ç½®è‡ªåŠ¨ç”ŸæˆVue Routerè·¯ç”±
- ğŸ¯ **æƒé™æ§åˆ¶**: æ”¯æŒåŸºäºè§’è‰²å’Œæƒé™çš„è·¯ç”±è®¿é—®æ§åˆ¶
- ğŸ”„ **å®æ—¶æ›´æ–°**: æ”¯æŒåŠ¨æ€æ·»åŠ ã€ç§»é™¤å’Œæ›´æ–°è·¯ç”±
- ğŸ“± **å“åº”å¼èœå•**: èœå•æ ¹æ®è·¯ç”±é…ç½®è‡ªåŠ¨æ›´æ–°
- ğŸ¨ **çµæ´»é…ç½®**: æ”¯æŒå›¾æ ‡ã€å›½é™…åŒ–ã€æ’åºç­‰é…ç½®

## ç³»ç»Ÿæ¶æ„

```
ç”¨æˆ·ç™»å½• â†’ è·å–ç”¨æˆ·ä¿¡æ¯ â†’ è·å–ç”¨æˆ·èœå• â†’ åŠ¨æ€ç”Ÿæˆè·¯ç”± â†’ æ›´æ–°èœå•æ˜¾ç¤º
    â†“
æƒé™éªŒè¯ â†’ è·¯ç”±å®ˆå« â†’ åŠ¨æ€è·¯ç”±ç®¡ç† â†’ ç»„ä»¶æ‡’åŠ è½½
```

## é…ç½®è¯´æ˜

### 1. å¯ç”¨æœåŠ¡ç«¯èœå•

åœ¨åº”ç”¨é…ç½®ä¸­è®¾ç½® `menuFromServer: true`ï¼š

```typescript
// åœ¨åº”ç”¨å•†åº—ä¸­è®¾ç½®
const appStore = useAppStore();
appStore.updateSettings({ menuFromServer: true });
```

### 2. æœåŠ¡ç«¯èœå•æ•°æ®ç»“æ„

æœåŠ¡ç«¯éœ€è¦è¿”å›ä»¥ä¸‹æ ¼å¼çš„èœå•æ•°æ®ï¼š

```typescript
interface PermissionTreeNode {
  id: number;
  name: string;           // èœå•åç§°
  code: string;           // èœå•ç¼–ç ï¼ˆç”¨ä½œè·¯ç”±åç§°ï¼‰
  path: string;           // è·¯ç”±è·¯å¾„
  component: string;      // ç»„ä»¶è·¯å¾„
  icon?: string;          // å›¾æ ‡
  localize?: string;      // å›½é™…åŒ–é”®
  roles?: string[];       // è§’è‰²æƒé™
  permissions?: string[]; // æƒé™æ ‡è¯†
  parentId?: number;      // çˆ¶çº§ID
  children?: PermissionTreeNode[]; // å­èœå•
}
```

### 3. ç»„ä»¶è·¯å¾„é…ç½®

ç»„ä»¶è·¯å¾„æ”¯æŒä»¥ä¸‹æ ¼å¼ï¼š

```typescript
// ç»å¯¹è·¯å¾„ï¼ˆæ¨èï¼‰
component: '@/views/dashboard/workplace'

// ç›¸å¯¹è·¯å¾„ï¼ˆç›¸å¯¹äºviewsç›®å½•ï¼‰
component: 'dashboard/workplace'
component: '/dashboard/workplace'

// è‡ªåŠ¨æ·»åŠ .vueæ‰©å±•å
component: 'dashboard/workplace' // å®é™…åŠ è½½: @/views/dashboard/workplace.vue
```

## ä½¿ç”¨ç¤ºä¾‹

### 1. åŸºæœ¬ä½¿ç”¨

```typescript
// åœ¨ç”¨æˆ·ç™»å½•æˆåŠŸåï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è·å–èœå•é…ç½®
// æ— éœ€æ‰‹åŠ¨è°ƒç”¨ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†

// å¦‚æœéœ€è¦æ‰‹åŠ¨åˆ·æ–°èœå•
const appStore = useAppStore();
await appStore.fetchServerMenuConfig();
```

### 2. åŠ¨æ€è·¯ç”±ç®¡ç†

```typescript
import { createDynamicRouteManager } from '@/router/dynamic-routes';

// åˆ›å»ºåŠ¨æ€è·¯ç”±ç®¡ç†å™¨
const dynamicRouteManager = createDynamicRouteManager(router);

// æ·»åŠ åŠ¨æ€è·¯ç”±
await dynamicRouteManager.addDynamicRoutes();

// ç§»é™¤åŠ¨æ€è·¯ç”±
dynamicRouteManager.removeDynamicRoutes();

// é‡ç½®åŠ¨æ€è·¯ç”±
await dynamicRouteManager.resetDynamicRoutes();
```

### 3. æƒé™æ§åˆ¶

```typescript
// åœ¨è·¯ç”±metaä¸­é…ç½®æƒé™
{
  path: '/admin',
  name: 'admin',
  component: 'admin/index',
  meta: {
    roles: ['admin', 'super_admin'],     // è§’è‰²æƒé™
    permissions: ['admin:read'],         // æƒé™æ ‡è¯†
    requiresAuth: true                   // éœ€è¦è®¤è¯
  }
}
```

## è·¯ç”±å®ˆå«

ç³»ç»ŸåŒ…å«ä»¥ä¸‹è·¯ç”±å®ˆå«ï¼š

### 1. ç”¨æˆ·ç™»å½•ä¿¡æ¯å®ˆå« (`userLoginInfo.ts`)
- æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
- è·å–ç”¨æˆ·ä¿¡æ¯
- è‡ªåŠ¨è·å–èœå•é…ç½®

### 2. æƒé™å®ˆå« (`permission.ts`)
- æ£€æŸ¥è·¯ç”±è®¿é—®æƒé™
- åŠ¨æ€è·¯ç”±åŒ¹é…
- æƒé™éªŒè¯

### 3. é¡µé¢å®ˆå« (`index.ts`)
- è·¯ç”±å˜åŒ–ç›‘å¬
- é¡µé¢äº‹ä»¶å‘å°„

## èœå•ç»„ä»¶

### 1. èœå•æ ‘é’©å­ (`use-menu-tree.ts`)
- æ„å»ºèœå•æ ‘ç»“æ„
- æƒé™è¿‡æ»¤
- æ’åºå¤„ç†

### 2. èœå•ç»„ä»¶ (`menu/index.vue`)
- æ¸²æŸ“èœå•æ ‘
- å¤„ç†èœå•ç‚¹å‡»
- æ”¯æŒæŠ˜å å±•å¼€

## é…ç½®é€‰é¡¹

### åº”ç”¨é…ç½®

```typescript
interface AppState {
  menuFromServer: boolean;        // æ˜¯å¦ä½¿ç”¨æœåŠ¡ç«¯èœå•
  serverMenu: RouteRecordRaw[];   // æœåŠ¡ç«¯è·¯ç”±é…ç½®
  serverMenuTree: any[];          // æœåŠ¡ç«¯èœå•æ ‘
  // ... å…¶ä»–é…ç½®
}
```

### è·¯ç”±å…ƒä¿¡æ¯

```typescript
interface RouteMeta {
  title?: string;           // é¡µé¢æ ‡é¢˜
  icon?: string;            // å›¾æ ‡
  locale?: string;          // å›½é™…åŒ–é”®
  requiresAuth: boolean;    // éœ€è¦è®¤è¯
  roles?: string[];         // è§’è‰²æƒé™
  permissions?: string[];   // æƒé™æ ‡è¯†
  hideInMenu?: boolean;     // éšè—èœå•
  order?: number;           // æ’åº
}
```

## æœ€ä½³å®è·µ

### 1. èœå•é…ç½®

- ä½¿ç”¨æœ‰æ„ä¹‰çš„è·¯å¾„å’Œåç§°
- åˆç†é…ç½®å›¾æ ‡å’Œå›½é™…åŒ–
- è®¾ç½®é€‚å½“çš„æƒé™æ§åˆ¶

### 2. ç»„ä»¶å¼€å‘

- ç»„ä»¶è·¯å¾„è¦ä¸èœå•é…ç½®ä¸€è‡´
- å®ç°é€‚å½“çš„é”™è¯¯è¾¹ç•Œ
- ä½¿ç”¨æ‡’åŠ è½½ä¼˜åŒ–æ€§èƒ½

### 3. æƒé™æ§åˆ¶

- å‰åç«¯æƒé™ä¿æŒä¸€è‡´
- å®ç°ç»†ç²’åº¦çš„æƒé™æ§åˆ¶
- è®°å½•æƒé™éªŒè¯æ—¥å¿—

### 4. æ€§èƒ½ä¼˜åŒ–

- åˆç†ä½¿ç”¨è·¯ç”±æ‡’åŠ è½½
- é¿å…ä¸å¿…è¦çš„è·¯ç”±é‡å»º
- å®ç°èœå•ç¼“å­˜ç­–ç•¥

## æ•…éšœæ’é™¤

### 1. å¸¸è§é—®é¢˜

**Q: èœå•ä¸æ˜¾ç¤º**
A: æ£€æŸ¥ `menuFromServer` é…ç½®ï¼Œç¡®ä¿æœåŠ¡ç«¯è¿”å›æ­£ç¡®çš„èœå•æ•°æ®

**Q: è·¯ç”±è·³è½¬å¤±è´¥**
A: æ£€æŸ¥ç»„ä»¶è·¯å¾„é…ç½®ï¼Œç¡®ä¿ç»„ä»¶æ–‡ä»¶å­˜åœ¨

**Q: æƒé™éªŒè¯å¤±è´¥**
A: æ£€æŸ¥ç”¨æˆ·è§’è‰²å’Œæƒé™é…ç½®ï¼Œç¡®ä¿æƒé™æ•°æ®æ­£ç¡®

### 2. è°ƒè¯•æ–¹æ³•

```typescript
// æŸ¥çœ‹å½“å‰èœå•é…ç½®
console.log('æœåŠ¡ç«¯èœå•:', appStore.serverMenu);
console.log('èœå•æ ‘:', appStore.serverMenuTree);

// æŸ¥çœ‹åŠ¨æ€è·¯ç”±
console.log('å·²æ·»åŠ è·¯ç”±:', dynamicRouteManager.getAddedRoutes());
```

### 3. æ—¥å¿—è®°å½•

ç³»ç»Ÿä¼šè‡ªåŠ¨è®°å½•ä»¥ä¸‹æ—¥å¿—ï¼š
- èœå•é…ç½®åŠ è½½çŠ¶æ€
- è·¯ç”±æ·»åŠ /ç§»é™¤æ“ä½œ
- æƒé™éªŒè¯ç»“æœ
- é”™è¯¯ä¿¡æ¯

## æ‰©å±•åŠŸèƒ½

### 1. è‡ªå®šä¹‰è·¯ç”±è½¬æ¢

```typescript
// è‡ªå®šä¹‰è·¯ç”±è½¬æ¢é€»è¾‘
function customRouteConverter(menu: PermissionTreeNode): RouteRecordRaw {
  // è‡ªå®šä¹‰è½¬æ¢é€»è¾‘
  return {
    // ... è·¯ç”±é…ç½®
  };
}
```

### 2. èœå•ç¼“å­˜

```typescript
// å®ç°èœå•ç¼“å­˜
const menuCache = new Map();
// ... ç¼“å­˜é€»è¾‘
```

### 3. æƒé™ç­–ç•¥

```typescript
// è‡ªå®šä¹‰æƒé™ç­–ç•¥
class CustomPermissionStrategy {
  // ... æƒé™ç­–ç•¥å®ç°
}
```

## æ€»ç»“

åŠ¨æ€è·¯ç”±ç³»ç»Ÿæä¾›äº†çµæ´»ã€å¯æ‰©å±•çš„è·¯ç”±ç®¡ç†æ–¹æ¡ˆï¼Œé€šè¿‡åˆç†çš„é…ç½®å’Œä½¿ç”¨ï¼Œå¯ä»¥å®ç°ï¼š

- åŸºäºç”¨æˆ·æƒé™çš„åŠ¨æ€èœå•
- çµæ´»çš„è·¯ç”±é…ç½®ç®¡ç†
- è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒ
- å¯ç»´æŠ¤çš„ä»£ç ç»“æ„

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒä»£ç æ³¨é‡Šæˆ–è”ç³»å¼€å‘å›¢é˜Ÿã€‚
